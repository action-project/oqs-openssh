#!/bin/bash
set -ueox pipefail

PARENT_DIR=$(pwd)
SCRIPT_DIR=$(dirname $(realpath "$0"))

OPENSSL_SYS_DIR=${OPENSSL_SYS_DIR:-"/usr"}

git submodule update
cd "${SCRIPT_DIR}"
LIB_SUFFIX=$(./.init suffix)

if [ -f Makefile ]; then
    make clean
else
    autoreconf -i
fi

./configure \
    --prefix="${PARENT_DIR}" \
    --with-ldflags="-Wl,-rpath -Wl,${PARENT_DIR}/usr/${LIB_SUFFIX}" \
    --with-libs=-lm --with-ssl-dir="${OPENSSL_SYS_DIR}" \
    --with-liboqs-dir="${PARENT_DIR}/usr" \
    --with-cflags="-I${PARENT_DIR}/usr/include" \
    --sysconfdir="${PARENT_DIR}/.conf"
make -j
make install

cd "${PARENT_DIR}"
